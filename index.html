<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–®–≤–∏–¥–∫–æ –ø—Ä–æ–¥–∞–π ‚Äî –±–∞—Ä–∞—Ö–æ–ª–∫–∞ –æ–≥–æ–ª–æ—à–µ–Ω—å</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="theme-color" content="#07142e"/>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: radial-gradient(1100px 800px at 50% 10%, #0a1f44 0%, #081939 42%, #07142e 100%);
      --paper:#fff; --ink:#000;
      --brand:#ffd33b; --brand-press:#ffbf00;
      --line:rgba(255,255,255,.14); --glass:rgba(12,20,44,.68);
      --field-bg:rgba(255,255,255,.08); --field-br:rgba(255,255,255,.22);
      --ph:rgba(255,255,255,.75);
      --menu-bg:#0b1635; --menu-br:rgba(255,255,255,.22); --menu-hover:rgba(255,255,255,.10);
      --top:60px;
      --ok:#18d76e;
      --hotGrad: linear-gradient(90deg, #ff7a00, #ff0033);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--paper); font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}

    /* Topbar */
    .topbar{ position:sticky; top:0; z-index:100; height:var(--top); display:flex; align-items:center; gap:10px; padding:10px 12px; background:linear-gradient(180deg, rgba(7,15,35,.95), rgba(7,15,35,.72)); border-bottom:1px solid var(--line); }
    .logo{background:var(--brand); color:#111; border-radius:12px; padding:8px 12px; font:700 16px/1 "Russo One",sans-serif;}
    .pill{display:inline-flex; align-items:center; gap:8px; height:38px; padding:0 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); cursor:pointer; font-weight:700;}
    .pill.yellow{background:var(--brand); color:#111; border-color:rgba(0,0,0,.2); font-family:"Russo One"; text-transform:uppercase;}
    .grow{flex:1}

    .container{max-width:1200px; margin:12px auto; padding:0 12px;}
    .panel{background:var(--glass); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 20px 40px rgba(0,0,0,.45); backdrop-filter:saturate(130%) blur(8px);}

    /* HOT strip */
    .hotWrap{margin:12px 0}
    .hotHead{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    .hotHead .tag{background:var(--hotGrad); padding:8px 12px; border-radius:12px; font:700 14px/1 "Russo One"}
    .hotGrid{display:grid; grid-template-columns:repeat(5,1fr); gap:10px}
    @media (max-width:1024px){ .hotGrid{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:640px){ .hotGrid{grid-template-columns:repeat(2,1fr);} }
    .hotCard{position:relative; border:1px solid var(--line); border-radius:12px; overflow:hidden; background:rgba(255,255,255,.06); cursor:pointer}
    .hotCard .thumb{position:relative; padding-top:56%; background:#0b3a8a}
    .hotBadge{position:absolute; left:8px; top:8px; background:var(--hotGrad); padding:4px 8px; border-radius:10px; font:700 12px/1 "Russo One"}
    .hotPrice{position:absolute; right:8px; bottom:8px; background:rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.25); padding:4px 8px; border-radius:10px; font-weight:700; font-size:12px}
    .hotBody{padding:8px; font-size:13px}
    .hotTTL{font:700 14px/1.2 "Russo One"}

    /* Filters */
    .filters{display:grid; grid-template-columns:repeat(6,1fr); gap:10px;}
    @media (max-width:1024px){ .filters{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:640px){ .filters{grid-template-columns:1fr 1fr;} }
    label{font-size:12px; font-weight:800; opacity:.92; display:block; margin:0 0 6px;}
    .input,.select{ width:100%; height:46px; border-radius:12px; border:1px solid var(--field-br); background:var(--field-bg); color:#fff; padding:0 12px; font-size:14px; outline:none; }
    .input::placeholder{color:var(--ph)}
    .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .btn{height:48px; border:none; border-radius:14px; background:var(--brand); color:#111; font:700 16px/48px "Russo One"; padding:0 18px; cursor:pointer; box-shadow:0 6px 0 rgba(0,0,0,.35), inset 0 -3px 0 rgba(0,0,0,.18);}
    .btn:active{transform:translateY(2px); background:var(--brand-press); box-shadow:0 4px 0 rgba(0,0,0,.35), inset 0 -2px 0 rgba(0,0,0,.18);}
    .btn.ghost{background:rgba(255,255,255,.1); color:#fff;}

    /* Nice Select (desktop) ‚Äî portal overlay */
    @media (hover:hover){
      .select.nice-hidden{position:absolute; inset:0; opacity:0; pointer-events:none}
      .nice{position:relative}
      .nice-btn{ width:100%; height:46px; border-radius:12px; border:1px solid var(--field-br); background:var(--field-bg); color:#fff; padding:0 38px 0 12px; text-align:left; font-size:14px; font-weight:600; cursor:pointer; }
      .nice-btn:after{content:"‚ñæ"; position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.8; pointer-events:none}
      .nice-list{ position:fixed; left:0; top:0; width:260px; background:var(--menu-bg); border:1px solid var(--menu-br); border-radius:12px; padding:6px; box-shadow:0 18px 38px rgba(0,0,0,.6); display:none; max-height:280px; overflow:auto; z-index:2147483647; }
      .nice-item{padding:10px 12px; border-radius:10px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
      .nice-item:hover{background:var(--menu-hover)}
      .nice-item.active{background:rgba(255,255,255,.12)}
    }

    .topline{display:flex; align-items:center; gap:10px; margin:14px 0;}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px;}
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr;} }

    .card{ background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; cursor:pointer; transition:transform .08s ease, box-shadow .08s ease; }
    .card:active{transform:translateY(1px); box-shadow:0 10px 22px rgba(0,0,0,.35)}
    .thumb{position:relative; padding-top:62%; background:#0b3a8a; overflow:hidden;}
    .thumb img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
    .badge{position:absolute; left:8px; bottom:8px; background:var(--brand); color:#111; border-radius:10px; padding:6px 10px; font:700 14px/1 "Russo One";}
    .views{position:absolute; right:8px; bottom:8px; background:rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.25); color:#fff; border-radius:10px; padding:5px 8px; font-weight:700; font-size:12px}
    .likeBtn{position:absolute; right:8px; top:8px; height:38px; min-width:38px; padding:0 8px; border-radius:12px; border:1px solid rgba(255,255,255,.35); background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.35)); color:#fff; font-weight:900; font-size:16px; line-height:36px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.55); backdrop-filter:saturate(110%) blur(3px); }
    .likeBtn span{font-weight:800; margin-left:6px}
    .body{padding:10px; display:flex; flex-direction:column; gap:6px}
    .title{font:700 16px/1.2 "Russo One"; letter-spacing:.4px}

    .detail{position:fixed; inset:0; z-index:120; display:none; background:rgba(0,0,0,.5);}
    .detail.active{display:block;}
    .sheet{position:absolute; left:50%; top:6vh; transform:translateX(-50%); width:min(1080px,96vw); max-height:88vh; overflow:auto; background:var(--glass); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 20px 40px rgba(0,0,0,.6); backdrop-filter:saturate(130%) blur(8px);}

    /* Gallery */
    .big{position:relative; padding-top:56%; background:#0b3a8a; border-radius:12px; overflow:hidden}
    .big img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    .navBtn{
      position:absolute; top:50%; transform:translateY(-50%);
      height:48px; min-width:48px; padding:0 12px;
      border-radius:14px; border:1px solid rgba(255,255,255,.35);
      background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.35));
      color:#fff; font-weight:900; font-size:26px; line-height:46px;
      cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.55);
      backdrop-filter:saturate(110%) blur(3px); text-shadow:0 1px 2px rgba(0,0,0,.8);
    }
    .navPrev{left:8px} .navNext{right:8px}

    .specs{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
    @media (max-width:900px){ .specs{grid-template-columns:repeat(2,1fr);} }
    .spec{background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:12px; padding:8px; font-size:13px}
    .h{font:700 14px/1 "Russo One"; margin-bottom:6px}
    .divider{height:1px; background:var(--line); margin:10px 0}
    .seller{display:flex; gap:10px; align-items:center}
    .avatar{width:44px; height:44px; border-radius:50%; background:#203157; display:flex; align-items:center; justify-content:center; font-weight:800}

    .pager{display:flex; justify-content:center; margin:16px 0 40px}
    #dAttribution{display:none}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo">–®–≤–∏–¥–∫–æ –ø—Ä–æ–¥–∞–π</div>
    <div class="pill yellow" id="tabSearch">–ü–æ—à—É–∫</div>
    <div class="pill" id="tabSell">–î–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>
    <div class="grow"></div>
  </header>

  <main class="container">
    <!-- HOT -->
    <section class="panel hotWrap" id="hotPanel" style="display:none">
      <div class="hotHead">
        <div class="tag">üî• HOT ‚Äî –¢–û–ü-10 (–¥–æ <span id="hotUntil"></span>)</div>
        <div style="opacity:.8;font-size:12px">–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ –Ω–∞ 7 –¥–Ω—ñ–≤</div>
      </div>
      <div class="hotGrid" id="hotGrid"></div>
    </section>

    <!-- –§–Ü–õ–¨–¢–†–ò -->
    <section class="panel" id="searchPanel">
      <div class="filters" id="filters">
        <div>
          <label>–û–±–ª–∞—Å—Ç—å</label>
          <select class="select" id="fltRegion" data-placeholder="–ë—É–¥—å-—è–∫–∞ –æ–±–ª–∞—Å—Ç—å"></select>
        </div>
        <div>
          <label>–ú—ñ—Å—Ç–æ</label>
          <select class="select" id="fltCity" data-placeholder="–ë—É–¥—å-—è–∫–µ –º—ñ—Å—Ç–æ"></select>
        </div>

        <div><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label><select class="select" id="fltCat" data-placeholder="–ë—É–¥—å-—â–æ"></select></div>
        <div><label>–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label><select class="select" id="fltSubcat" data-placeholder="–ë—É–¥—å-—â–æ"></select></div>
        <div><label>–°—Ç–∞–Ω</label><select class="select" id="fltCond" data-placeholder="–ë—É–¥—å-—â–æ"></select></div>
        <div><label>–¢–∏–ø –ø—Ä–æ–¥–∞–≤—Ü—è</label><select class="select" id="fltSeller" data-placeholder="–ë—É–¥—å-—â–æ"></select></div>
        <div><label>–¶—ñ–Ω–∞ –≤—ñ–¥, ‚Ç¥</label><input class="input" id="fltPriceMin" placeholder="0"></div>
        <div><label>–¶—ñ–Ω–∞ –¥–æ, ‚Ç¥</label><input class="input" id="fltPriceMax" placeholder="‚àû"></div>

        <div style="grid-column:1/-1"><label>–ü–æ—à—É–∫</label><input class="input" id="fltQuery" placeholder="–ù–∞–∑–≤–∞, –±—Ä–µ–Ω–¥, –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞"></div>
        <div class="check"><input type="checkbox" id="fltRecent"> <label for="fltRecent">–ó–∞ 30 –¥–Ω—ñ–≤</label></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnApply">–ó–Ω–∞–π—Ç–∏</button>
        <button class="btn ghost" id="btnReset">–°–∫–∏–Ω—É—Ç–∏</button>
        <select class="select" id="sortBy" style="max-width:260px">
          <option value="new">–°–æ—Ä—Ç—É–≤–∞—Ç–∏: –Ω–æ–≤—ñ</option>
          <option value="priceAsc">–¶—ñ–Ω–∞ ‚Üë</option>
          <option value="priceDesc">–¶—ñ–Ω–∞ ‚Üì</option>
          <option value="likesDesc">–õ–∞–π–∫–∏ ‚Üì</option>
          <option value="viewsDesc">–ü–µ—Ä–µ–≥–ª—è–¥–∏ ‚Üì</option>
        </select>
      </div>
    </section>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–ò -->
    <section class="topline">
      <div id="resCount">0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</div>
      <div class="grow"></div>
    </section>
    <section class="grid" id="grid"></section>
    <div class="pager"><button class="btn" id="btnMore" style="display:none">–ü–æ–∫–∞–∑–∞—Ç–∏ —â–µ</button></div>

    <!-- –î–û–î–ê–¢–ò –û–ì–û–õ–û–®–ï–ù–ù–Ø -->
    <section id="sellPanel" class="panel" style="display:none; margin-top:14px">
      <h3 style="margin:0 0 8px; font:700 18px/1 'Russo One'">–î–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h3>
      <div class="filters" style="grid-template-columns:repeat(3,1fr)">
        <div><label>–û–±–ª–∞—Å—Ç—å</label><select class="select" id="sRegion"></select></div>
        <div><label>–ú—ñ—Å—Ç–æ</label><select class="select" id="sCity"></select></div>
        <div><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label><select class="select" id="sCat"></select></div>
        <div><label>–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label><select class="select" id="sSubcat"></select></div>
        <div style="grid-column:1/-1"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input class="input" id="sTitle" placeholder="–ù–∞–ø—Ä., iPhone 13, 128GB, —Å—Ç–∞–Ω 9/10"></div>
        <div><label>–°—Ç–∞–Ω</label><select class="select" id="sCond"></select></div>
        <div><label>–¢–∏–ø –ø—Ä–æ–¥–∞–≤—Ü—è</label><select class="select" id="sSeller"></select></div>
        <div><label>–¶—ñ–Ω–∞, ‚Ç¥</label><input class="input" id="sPrice" placeholder="15000"></div>
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω (–ø—É–±–ª—ñ—á–Ω–∏–π)</label><input class="input" id="sPhone" placeholder="+380 (..) ...-..-.."></div>
        <div style="grid-column:1/-1"><label>–û–ø–∏—Å</label><textarea class="input" id="sDesc" rows="3" style="height:auto; padding:10px" placeholder="–°—Ç–∞–Ω, –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü—ñ—è, —Å–∞–º–æ–≤–∏–≤—ñ–∑/–¥–æ—Å—Ç–∞–≤–∫–∞... (–º—ñ–Ω. 20 —Å–∏–º–≤–æ–ª—ñ–≤)"></textarea></div>
        <div style="grid-column:1/-1"><label>URL —Ñ–æ—Ç–æ (—á–µ—Ä–µ–∑ |)</label><input class="input" id="sImages" placeholder="https://...jpg|https://...jpg"></div>
      </div>
      <div class="actions">
        <button class="btn" id="sSave">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        <div style="opacity:.7;font-size:12px">–ê–Ω—Ç–∏—Å–ø–∞–º: 1 –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è / 60 —Å–µ–∫.</div>
      </div>
    </section>
  </main>

  <!-- DETAIL -->
  <div id="detail" class="detail" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        <div class="logo">–®–≤–∏–¥–∫–æ –ø—Ä–æ–¥–∞–π</div>
        <div class="grow"></div>
        <button class="btn close" id="dLike" style="height:38px; line-height:38px; border-radius:12px; font:700 13px/38px 'Russo One'">‚ô• –õ–∞–π–∫</button>
        <button class="btn close" id="dClose" style="height:38px; line-height:38px; border-radius:12px; font:700 13px/38px 'Russo One'">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
      <div id="dHeader" style="display:flex; align-items:center; gap:10px; margin-bottom:8px"></div>
      <div id="dGal"></div>
      <div class="divider"></div>
      <div class="specs" id="dSpecs"></div>
      <div class="divider"></div>
      <div id="dDesc" style="opacity:.9"></div>
      <div class="divider"></div>
      <div class="seller" id="dSeller"></div>
      <div id="dAttribution" style="margin-top:8px; font-size:12px; opacity:.8"></div>
    </div>
  </div>

  <script>
  const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
  const DB_KEY = "spd_listings_v2";       // –±–∞–∑–∞ –æ–≥–æ–ª–æ—à–µ–Ω—å (v2)
  const CTRL_KEY = "spd_ctrl_v1";         // —Å–ª—É–∂–±–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

  /* ===== –£–∫—Ä–∞—ó–Ω–∞: 24 –æ–±–ª–∞—Å—Ç—ñ ‚Üí –º—ñ—Å—Ç–∞ (–æ–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏ —Ç–∞ –∫—ñ–ª—å–∫–∞ –º—ñ—Å—Ç) ===== */
  const UA_REGIONS = {
    "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞":["–í—ñ–Ω–Ω–∏—Ü—è","–ñ–º–µ—Ä–∏–Ω–∫–∞","–ú–æ–≥–∏–ª—ñ–≤-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π"],
    "–í–æ–ª–∏–Ω—Å—å–∫–∞":["–õ—É—Ü—å–∫","–ö–æ–≤–µ–ª—å","–í–æ–ª–æ–¥–∏–º–∏—Ä"],
    "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞":["–î–Ω—ñ–ø—Ä–æ","–ö—Ä–∏–≤–∏–π –†—ñ–≥","–ö–∞–º'—è–Ω—Å—å–∫–µ","–ù—ñ–∫–æ–ø–æ–ª—å","–ü–∞–≤–ª–æ–≥—Ä–∞–¥"],
    "–î–æ–Ω–µ—Ü—å–∫–∞":["–î–æ–Ω–µ—Ü—å–∫","–ú–∞—Ä—ñ—É–ø–æ–ª—å","–ö—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫","–°–ª–æ–≤'—è–Ω—Å—å–∫"],
    "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞":["–ñ–∏—Ç–æ–º–∏—Ä","–ë–µ—Ä–¥–∏—á—ñ–≤","–ö–æ—Ä–æ—Å—Ç–µ–Ω—å"],
    "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞":["–£–∂–≥–æ—Ä–æ–¥","–ú—É–∫–∞—á–µ–≤–æ","–•—É—Å—Ç"],
    "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞":["–ó–∞–ø–æ—Ä—ñ–∂–∂—è","–ë–µ—Ä–¥—è–Ω—Å—å–∫","–ú–µ–ª—ñ—Ç–æ–ø–æ–ª—å"],
    "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞":["–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫","–ö–∞–ª—É—à","–ö–æ–ª–æ–º–∏—è","–Ø—Ä–µ–º—á–µ"],
    "–ö–∏—ó–≤—Å—å–∫–∞":["–ö–∏—ó–≤","–ë—ñ–ª–∞ –¶–µ—Ä–∫–≤–∞","–ë—Ä–æ–≤–∞—Ä–∏","–ë–æ—Ä–∏—Å–ø—ñ–ª—å","–Ü—Ä–ø—ñ–Ω—å","–ë—É—á–∞"],
    "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞":["–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π","–û–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—è","–°–≤—ñ—Ç–ª–æ–≤–æ–¥—Å—å–∫"],
    "–õ—É–≥–∞–Ω—Å—å–∫–∞":["–õ—É–≥–∞–Ω—Å—å–∫","–°—î–≤—î—Ä–æ–¥–æ–Ω–µ—Ü—å–∫","–õ–∏—Å–∏—á–∞–Ω—Å—å–∫","–†—É–±—ñ–∂–Ω–µ"],
    "–õ—å–≤—ñ–≤—Å—å–∫–∞":["–õ—å–≤—ñ–≤","–î—Ä–æ–≥–æ–±–∏—á","–ß–µ—Ä–≤–æ–Ω–æ–≥—Ä–∞–¥","–°—Ç—Ä–∏–π"],
    "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞":["–ú–∏–∫–æ–ª–∞—ó–≤","–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫","–Æ–∂–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫"],
    "–û–¥–µ—Å—å–∫–∞":["–û–¥–µ—Å–∞","–ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫","–Æ–∂–Ω–µ","–Ü–∑–º–∞—ó–ª","–ë—ñ–ª–≥–æ—Ä–æ–¥-–î–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫–∏–π"],
    "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞":["–ü–æ–ª—Ç–∞–≤–∞","–ö—Ä–µ–º–µ–Ω—á—É–∫","–ú–∏—Ä–≥–æ—Ä–æ–¥"],
    "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞":["–†—ñ–≤–Ω–µ","–î—É–±–Ω–æ","–í–∞—Ä–∞—à"],
    "–°—É–º—Å—å–∫–∞":["–°—É–º–∏","–®–æ—Å—Ç–∫–∞","–ö–æ–Ω–æ—Ç–æ–ø","–û—Ö—Ç–∏—Ä–∫–∞"],
    "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞":["–¢–µ—Ä–Ω–æ–ø—ñ–ª—å","–ß–æ—Ä—Ç–∫—ñ–≤","–ö—Ä–µ–º–µ–Ω–µ—Ü—å"],
    "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞":["–•–∞—Ä–∫—ñ–≤","–õ–æ–∑–æ–≤–∞","–Ü–∑—é–º"],
    "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞":["–•–µ—Ä—Å–æ–Ω","–ù–æ–≤–∞ –ö–∞—Ö–æ–≤–∫–∞","–ö–∞—Ö–æ–≤–∫–∞"],
    "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞":["–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π","–ö–∞–º'—è–Ω–µ—Ü—å-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π","–®–µ–ø–µ—Ç—ñ–≤–∫–∞"],
    "–ß–µ—Ä–∫–∞—Å—å–∫–∞":["–ß–µ—Ä–∫–∞—Å–∏","–£–º–∞–Ω—å","–°–º—ñ–ª–∞"],
    "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞":["–ß–µ—Ä–Ω—ñ–≤—Ü—ñ","–•–æ—Ç–∏–Ω"],
    "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞":["–ß–µ—Ä–Ω—ñ–≥—ñ–≤","–ù—ñ–∂–∏–Ω","–ü—Ä–∏–ª—É–∫–∏"]
  };
  const REGIONS = Object.keys(UA_REGIONS).sort();
  const CITIES = REGIONS.flatMap(r => UA_REGIONS[r].map(c => ({city:c, region:r})));

  /* ===== –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó ===== */
  const CATS = {
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç":["–õ–µ–≥–∫–æ–≤—ñ –∞–≤—Ç–æ","–ú–æ—Ç–æ","–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏","–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∏/–ê–≤—Ç–æ–±—É—Å–∏","–®–∏–Ω–∏/–î–∏—Å–∫–∏"],
    "–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å":["–ö–≤–∞—Ä—Ç–∏—Ä–∏","–ë—É–¥–∏–Ω–∫–∏","–û—Ä–µ–Ω–¥–∞","–î—ñ–ª—è–Ω–∫–∏","–ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞"],
    "–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞":["–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏","–ù–æ—É—Ç–±—É–∫–∏/–ü–ö","–¢–µ—Ö–Ω—ñ–∫–∞ –¥–ª—è –¥–æ–º—É","TV/–ê—É–¥—ñ–æ","–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ"],
    "–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É":["–ú–µ–±–ª—ñ","–ö—É—Ö–Ω—è","–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏","–°–∞–¥/–ì–æ—Ä–æ–¥","–î–µ–∫–æ—Ä"],
    "–†–æ–±–æ—Ç–∞":["–í–∞–∫–∞–Ω—Å—ñ—ó","–ü—ñ–¥—Ä–æ–±—ñ—Ç–æ–∫","–í—ñ–¥–¥–∞–ª–µ–Ω–æ"],
    "–ü–æ—Å–ª—É–≥–∏":["–†–µ–º–æ–Ω—Ç","–î–æ—Å—Ç–∞–≤–∫–∞","–§–æ—Ç–æ/–í—ñ–¥–µ–æ","–û—Å–≤—ñ—Ç–∞","–õ–æ–≥—ñ—Å—Ç–∏–∫–∞"],
    "–ú–æ–¥–∞":["–û–¥—è–≥","–í–∑—É—Ç—Ç—è","–ê–∫—Å–µ—Å—É–∞—Ä–∏"],
    "–î—ñ—Ç–∏":["–í—ñ–∑–æ—á–∫–∏","–Ü–≥—Ä–∞—à–∫–∏","–û–¥—è–≥"],
    "–°–ø–æ—Ä—Ç/–•–æ–±—ñ":["–í–µ–ª–æ—Å–∏–ø–µ–¥–∏","–¢—É—Ä–∏–∑–º","–ú—É–∑–∏—á–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏"],
    "–¢–≤–∞—Ä–∏–Ω–∏":["–ö–æ—Ç–∏","–°–æ–±–∞–∫–∏","–ó–æ–æ—Ç–æ–≤–∞—Ä–∏"]
  };
  const CONDS=["–ù–æ–≤–µ","–í–∂–∏–≤–∞–Ω–µ","–ü—ñ—Å–ª—è —Ä–µ–º–æ–Ω—Ç—É"];
  const SELLERS=["–ü—Ä–∏–≤–∞—Ç–Ω–∏–π","–ë—ñ–∑–Ω–µ—Å"];

  /* ===== –§–æ—Ç–æ: —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ –ø—ñ–¥–±—ñ—Ä–∫–∏ (Wikimedia/Unsplash) ===== */
  const IMG = {
    car:[
      "https://images.unsplash.com/photo-1549921296-3ecf9a5e7fdf?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1483721310020-03333e577078?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1511919884226-fd3cad34687c?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1440&q=60"
    ],
    moto:[
      "https://images.unsplash.com/photo-1517677208171-0bc6725a3e60?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1473186578172-c141e6798cf4?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1518551933037-3f6fdf0c5f39?auto=format&fit=crop&w=1440&q=60"
    ],
    parts:[
      "https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1517048676732-d65bc937f952?auto=format&fit=crop&w=1440&q=60"
    ],
    truck:[
      "https://images.unsplash.com/photo-1531747061943-31c6d164f90b?auto=format&fit=crop&w=1440&q=60"
    ],
    tires:[
      "https://images.unsplash.com/photo-1530041682227-3b1f229e3b4b?auto=format&fit=crop&w=1440&q=60"
    ],
    phone:[
      "https://images.unsplash.com/photo-1635070041078-e363dbe005cb?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1603899122329-75b7efed2b43?auto=format&fit=crop&w=1440&q=60"
    ],
    laptop:[
      "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1440&q=60"
    ],
    homeappl:[
      "https://images.unsplash.com/photo-1581579188871-45ea61f2a0c8?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1571171637578-41bc2dd41cd2?auto=format&fit=crop&w=1440&q=60"
    ],
    tv:[
      "https://images.unsplash.com/photo-1585647347483-22b66260d84e?auto=format&fit=crop&w=1440&q=60"
    ],
    console:[
      "https://images.unsplash.com/photo-1603487742131-8e362d3d6d5c?auto=format&fit=crop&w=1440&q=60"
    ],
    furniture:[
      "https://images.unsplash.com/photo-1493666438817-866a91353ca9?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=1440&q=60"
    ],
    kitchen:[
      "https://images.unsplash.com/photo-1505691723518-36a5ac3b2d5b?auto=format&fit=crop&w=1440&q=60"
    ],
    tools:[
      "https://images.unsplash.com/photo-1517685352821-92cf88aee5a5?auto=format&fit=crop&w=1440&q=60",
      "https://images.unsplash.com/photo-1497366858526-0766cadbe8fa?auto=format&fit=crop&w=1440&q=60"
    ],
    garden:[
      "https://images.unsplash.com/photo-1523419410729-4061a6b18f5e?auto=format&fit=crop&w=1440&q=60"
    ],
    decor:[
      "https://images.unsplash.com/photo-1484154218962-a197022b5858?auto=format&fit=crop&w=1440&q=60"
    ],
    jobs:[
      "https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1440&q=60"
    ],
    services:[
      "https://images.unsplash.com/photo-1526948128573-703ee1aeb6fa?auto=format&fit=crop&w=1440&q=60"
    ],
    fashion:[
      "https://images.unsplash.com/photo-1520975922284-9e0ce827be0e?auto=format&fit=crop&w=1440&q=60"
    ],
    kids:[
      "https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1440&q=60"
    ],
    bikes:[
      "https://images.unsplash.com/photo-1519985176271-adb1088fa94c?auto=format&fit=crop&w=1440&q=60"
    ],
    music:[
      "https://images.unsplash.com/photo-1485579149621-3123dd979885?auto=format&fit=crop&w=1440&q=60"
    ],
    cats:["https://images.unsplash.com/photo-1595433707802-6b2626ef1c86?auto=format&fit=crop&w=1440&q=60"],
    dogs:["https://images.unsplash.com/photo-1517849845537-4d257902454a?auto=format&fit=crop&w=1440&q=60"],
    flats:["https://images.unsplash.com/photo-1494526585095-c41746248156?auto=format&fit=crop&w=1440&q=60"],
    houses:["https://images.unsplash.com/photo-1560185008-b033106af2d0?auto=format&fit=crop&w=1440&q=60"],
    land:["https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1440&q=60"],
    office:["https://images.unsplash.com/photo-1524758631624-e2822e304c36?auto=format&fit=crop&w=1440&q=60"]
  };

  /* ===== Helpers ===== */
  const getDB=()=>{try{return JSON.parse(localStorage.getItem(DB_KEY)||"[]")}catch{return[]}};
  const setDB=v=>localStorage.setItem(DB_KEY,JSON.stringify(v));
  const getCtrl=()=>{try{return JSON.parse(localStorage.getItem(CTRL_KEY)||"{}")}catch{return{}}};
  const setCtrl=v=>localStorage.setItem(CTRL_KEY,JSON.stringify(v));
  const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const pick=a=>a[Math.floor(Math.random()*a.length)];
  function fmtUA(date){ return new Date(date).toLocaleDateString('uk-UA'); }

  function createImg(src, alt, fallback){
    const img=document.createElement("img"); img.loading="lazy"; img.alt=alt; img.referrerPolicy="no-referrer";
    img.src = src || fallback; img.onerror=()=>{ img.onerror=null; img.src=fallback; }; return img;
  }
  function itemPNG(title, seed=0){
    const c=document.createElement('canvas'); c.width=800; c.height=500; const g=c.getContext('2d');
    const palettes=[["#0e2a58","#163b7a","#0b1d3b"],["#531a4e","#7b2c76","#1b0f2f"],["#0b3a2e","#147a60","#06241d"],["#6b1f1f","#a23333","#240909"]];
    const pal=palettes[seed%palettes.length]; const grad=g.createLinearGradient(0,0,800,500);
    grad.addColorStop(0,pal[0]); grad.addColorStop(1,pal[1]); g.fillStyle=grad; g.fillRect(0,0,800,500);
    g.fillStyle=pal[2]; g.fillRect(0,420,800,80);
    g.fillStyle='#ffd33b'; g.font="bold 42px 'Russo One', Arial"; g.textAlign="center"; g.fillText(title.slice(0,20), 400, 100);
    g.fillStyle="#ffffffaa"; for(let i=0;i<6;i++){ g.fillRect(120+i*90,220+Math.sin(i+seed)*20,60,120); }
    return c.toDataURL('image/png');
  }

  /* ===== Select helpers (region‚Üícity, cat‚Üísubcat) ===== */
  const fltRegion=$("#fltRegion"), fltCity=$("#fltCity"), fltCat=$("#fltCat"), fltSub=$("#fltSubcat"),
        fltCond=$("#fltCond"), fltSeller=$("#fltSeller"), fltPriceMin=$("#fltPriceMin"), fltPriceMax=$("#fltPriceMax"),
        fltQuery=$("#fltQuery"), fltRecent=$("#fltRecent");

  function fillSelect(el, arr, withAll=true, txt="–ë—É–¥—å-—â–æ"){
    el.innerHTML=(withAll?`<option value="">${txt}</option>`:'')+arr.map(x=>`<option value="${x}">${x}</option>`).join('');
  }
  function refreshCities(targetSel, regionVal, withAll=true){
    const list = regionVal ? UA_REGIONS[regionVal]||[] : [];
    fillSelect(targetSel, list, withAll, "–ë—É–¥—å-—è–∫–µ –º—ñ—Å—Ç–æ");
    // —è–∫—â–æ –±—É–ª–æ –∫–∞—Å—Ç–æ–º–Ω–µ ¬´–∫—Ä–∞—Å–∏–≤–µ¬ª –º–µ–Ω—é ‚Äî –≤–æ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º (–¥–∏–≤. enhanceSelect)
  }

  fillSelect(fltRegion, REGIONS, true, "–ë—É–¥—å-—è–∫–∞ –æ–±–ª–∞—Å—Ç—å");
  refreshCities(fltCity, "", true);
  fillSelect(fltCat, Object.keys(CATS));
  fillSelect(fltSub, []);
  fltCat.addEventListener('change', ()=> fillSelect(fltSub, fltCat.value?CATS[fltCat.value]:[]));

  fillSelect(fltCond, CONDS);
  fillSelect(fltSeller, SELLERS);

  /* ===== ¬´Nice select¬ª –∑ –¥–∏–Ω–∞–º—ñ—á–Ω–æ—é –ø–æ–±—É–¥–æ–≤–æ—é —Å–ø–∏—Å–∫—É ===== */
  let activeList=null, activeWrap=null;
  function closeAll(e){
    if(activeList){
      if(e && (activeList.contains(e.target) || activeWrap.contains(e.target))) return;
      activeList.style.display='none'; activeWrap.appendChild(activeList); activeList=null; activeWrap=null;
    }
  }
  document.addEventListener('click', closeAll);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAll(); });

  function enhanceSelect(sel){
    if (matchMedia('(hover: none)').matches) return; // –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –∑–∞–ª–∏—à–∞—î–º–æ —Ä—ñ–¥–Ω–∏–π select
    const wrap=document.createElement('div'); wrap.className='nice';
    const btn=document.createElement('button'); btn.type='button'; btn.className='nice-btn';
    const list=document.createElement('div'); list.className='nice-list';

    function buildList(){
      list.innerHTML='';
      [...sel.options].forEach((o, idx)=>{
        const it=document.createElement('div'); it.className='nice-item'+(o.selected?' active':''); it.textContent=o.text;
        it.onclick=(ev)=>{ ev.stopPropagation(); sel.selectedIndex=idx; btn.textContent=o.text; [...list.children].forEach(c=>c.classList.remove('active')); it.classList.add('active'); closeAll(); sel.dispatchEvent(new Event('change')); };
        list.appendChild(it);
      });
    }
    function refreshBtn(){
      const o = sel.options[sel.selectedIndex];
      btn.textContent = o ? o.text : (sel.getAttribute('data-placeholder')||'–í–∏–±–µ—Ä—ñ—Ç—å');
    }
    sel.classList.add('nice-hidden'); sel.parentNode.insertBefore(wrap, sel); wrap.appendChild(sel); wrap.appendChild(btn);
    refreshBtn();

    function open(){
      closeAll();
      buildList(); // <<< –∫–ª—é—á: –∞–∫—Ç—É–∞–ª—ñ–∑—É—î–º–æ –æ–ø—Ü—ñ—ó –ö–û–ñ–ï–ù —Ä–∞–∑ –ø–µ—Ä–µ–¥ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º
      const r=btn.getBoundingClientRect(); list.style.left = r.left+'px'; list.style.top = (r.bottom+6)+'px'; list.style.width = r.width+'px'; list.style.display='block'; document.body.appendChild(list); activeList=list; activeWrap=wrap;
    }
    btn.onclick=(e)=>{ e.stopPropagation(); if(activeList===list){ closeAll(); } else { open(); } };
  }
  $$('.select').forEach(enhanceSelect);

  // –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –æ–±–ª–∞—Å—Ç—å‚Üí–º—ñ—Å—Ç–æ (—Ñ—ñ–ª—å—Ç—Ä–∏)
  fltRegion.addEventListener('change', ()=>{ refreshCities(fltCity, fltRegion.value, true); });

  /* ===== –§–æ—Ç–æ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—î—é ===== */
  function imgBy(cat, sub){
    if(cat==="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" && sub==="–õ–µ–≥–∫–æ–≤—ñ –∞–≤—Ç–æ") return pick(IMG.car);
    if(cat==="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" && sub==="–ú–æ—Ç–æ") return pick(IMG.moto);
    if(cat==="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" && (sub||"").includes("–ó–∞–ø—á–∞—Å—Ç")) return pick(IMG.parts);
    if(cat==="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" && (sub||"").includes("–í–∞–Ω—Ç–∞–∂")) return pick(IMG.truck);
    if(cat==="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" && (sub||"").includes("–®–∏–Ω–∏")) return pick(IMG.tires);

    if(cat==="–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞" && sub==="–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏") return pick(IMG.phone);
    if(cat==="–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞" && sub==="–ù–æ—É—Ç–±—É–∫–∏/–ü–ö") return pick(IMG.laptop);
    if(cat==="–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞" && sub==="–¢–µ—Ö–Ω—ñ–∫–∞ –¥–ª—è –¥–æ–º—É") return pick(IMG.homeappl);
    if(cat==="–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞" && sub==="TV/–ê—É–¥—ñ–æ") return pick(IMG.tv);
    if(cat==="–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞" && sub==="–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ") return pick(IMG.console);

    if(cat==="–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É" && sub==="–ú–µ–±–ª—ñ") return pick(IMG.furniture);
    if(cat==="–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É" && sub==="–ö—É—Ö–Ω—è") return pick(IMG.kitchen);
    if(cat==="–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É" && sub==="–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏") return pick(IMG.tools);
    if(cat==="–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É" && sub==="–°–∞–¥/–ì–æ—Ä–æ–¥") return pick(IMG.garden);
    if(cat==="–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É" && sub==="–î–µ–∫–æ—Ä") return pick(IMG.decor);

    if(cat==="–°–ø–æ—Ä—Ç/–•–æ–±—ñ" && sub==="–í–µ–ª–æ—Å–∏–ø–µ–¥–∏") return pick(IMG.bikes);
    if(cat==="–°–ø–æ—Ä—Ç/–•–æ–±—ñ" && sub==="–ú—É–∑–∏—á–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏") return pick(IMG.music);

    if(cat==="–¢–≤–∞—Ä–∏–Ω–∏" && sub==="–ö–æ—Ç–∏") return pick(IMG.cats);
    if(cat==="–¢–≤–∞—Ä–∏–Ω–∏" && sub==="–°–æ–±–∞–∫–∏") return pick(IMG.dogs);

    if(cat==="–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å" && sub==="–ö–≤–∞—Ä—Ç–∏—Ä–∏") return pick(IMG.flats);
    if(cat==="–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å" && sub==="–ë—É–¥–∏–Ω–∫–∏") return pick(IMG.houses);
    if(cat==="–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å" && sub==="–î—ñ–ª—è–Ω–∫–∏") return pick(IMG.land);
    if(cat==="–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å" && sub==="–ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞") return pick(IMG.office);

    if(cat==="–ü–æ—Å–ª—É–≥–∏") return pick(IMG.services);
    if(cat==="–†–æ–±–æ—Ç–∞") return pick(IMG.jobs);
    if(cat==="–ú–æ–¥–∞") return pick(IMG.fashion);
    if(cat==="–î—ñ—Ç–∏") return pick(IMG.kids);

    return pick([pick(IMG.phone),pick(IMG.tools),pick(IMG.furniture)]);
  }

  /* ===== –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è 500 –æ–≥–æ–ª–æ—à–µ–Ω—å –∑ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º–∏ —Ü—ñ–Ω–∞–º–∏ ===== */
  const FIRSTNAMES=["–û–ª–µ–≥","–Ü—Ä–∏–Ω–∞","–°–µ—Ä–≥—ñ–π","–ê–Ω–Ω–∞","–í—ñ–∫—Ç–æ—Ä","–ú–∞–∫—Å–∏–º","–ú–∞—Ä—ñ—è","–Æ—Ä—ñ–π","–û–ª–µ–∫—Å—ñ–π","–ù–∞—Ç–∞–ª—ñ—è","–î–º–∏—Ç—Ä–æ","–û–ª–µ–Ω–∞","–ú–∏–∫–∏—Ç–∞","–ê–Ω–¥—Ä—ñ–π","–°–≤—ñ—Ç–ª–∞–Ω–∞"];
  const LASTNAMES=["–®–µ–≤—á–µ–Ω–∫–æ","–ö–æ–≤–∞–ª–µ–Ω–∫–æ","–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ","–¢–∫–∞—á–µ–Ω–∫–æ","–ö—Ä–∞–≤—á–µ–Ω–∫–æ","–ú–µ–ª—å–Ω–∏–∫","–ö–æ–≤–∞–ª—å—á—É–∫","–ü–µ—Ç—Ä–µ–Ω–∫–æ","–ü–æ–ª—ñ—â—É–∫","–ì—Ä–∏—Ü–µ–Ω–∫–æ","–°–∞–≤—á–µ–Ω–∫–æ","–ì–Ω–∞—Ç—é–∫","–Ø–∫–æ–≤–µ–Ω–∫–æ"];
  const OPERATORS=["50","63","66","67","68","73","93","95","96","97","98","99"];
  const PRICE = {
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:–õ–µ–≥–∫–æ–≤—ñ –∞–≤—Ç–æ":[120000,1500000],
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:–ú–æ—Ç–æ":[20000,400000],
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏":[300,30000],
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∏/–ê–≤—Ç–æ–±—É—Å–∏":[200000,2500000],
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:–®–∏–Ω–∏/–î–∏—Å–∫–∏":[500,40000],

    "–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞:–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏":[4000,50000],
    "–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞:–ù–æ—É—Ç–±—É–∫–∏/–ü–ö":[8000,90000],
    "–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞:–¢–µ—Ö–Ω—ñ–∫–∞ –¥–ª—è –¥–æ–º—É":[2000,40000],
    "–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞:TV/–ê—É–¥—ñ–æ":[3000,60000],
    "–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞:–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ":[6000,30000],

    "–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É:–ú–µ–±–ª—ñ":[1500,45000],
    "–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É:–ö—É—Ö–Ω—è":[500,20000],
    "–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É:–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏":[400,20000],
    "–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É:–°–∞–¥/–ì–æ—Ä–æ–¥":[200,12000],
    "–î–ª—è –¥–æ–º—É —Ç–∞ —Å–∞–¥—É:–î–µ–∫–æ—Ä":[200,8000],

    "–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å:–ö–≤–∞—Ä—Ç–∏—Ä–∏":[500000,7000000],
    "–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å:–ë—É–¥–∏–Ω–∫–∏":[800000,12000000],
    "–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å:–û—Ä–µ–Ω–¥–∞":[6000,45000],
    "–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å:–î—ñ–ª—è–Ω–∫–∏":[100000,3000000],
    "–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å:–ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞":[300000,15000000],

    "–†–æ–±–æ—Ç–∞:–í–∞–∫–∞–Ω—Å—ñ—ó":[10000,60000],
    "–†–æ–±–æ—Ç–∞:–ü—ñ–¥—Ä–æ–±—ñ—Ç–æ–∫":[500,10000],
    "–†–æ–±–æ—Ç–∞:–í—ñ–¥–¥–∞–ª–µ–Ω–æ":[8000,80000],

    "–ü–æ—Å–ª—É–≥–∏:–†–µ–º–æ–Ω—Ç":[300,20000],
    "–ü–æ—Å–ª—É–≥–∏:–î–æ—Å—Ç–∞–≤–∫–∞":[100,5000],
    "–ü–æ—Å–ª—É–≥–∏:–§–æ—Ç–æ/–í—ñ–¥–µ–æ":[500,30000],
    "–ü–æ—Å–ª—É–≥–∏:–û—Å–≤—ñ—Ç–∞":[300,15000],
    "–ü–æ—Å–ª—É–≥–∏:–õ–æ–≥—ñ—Å—Ç–∏–∫–∞":[500,25000],

    "–ú–æ–¥–∞:–û–¥—è–≥":[200,8000],
    "–ú–æ–¥–∞:–í–∑—É—Ç—Ç—è":[300,10000],
    "–ú–æ–¥–∞:–ê–∫—Å–µ—Å—É–∞—Ä–∏":[150,7000],

    "–î—ñ—Ç–∏:–í—ñ–∑–æ—á–∫–∏":[500,12000],
    "–î—ñ—Ç–∏:–Ü–≥—Ä–∞—à–∫–∏":[100,5000],
    "–î—ñ—Ç–∏:–û–¥—è–≥":[100,4000],

    "–°–ø–æ—Ä—Ç/–•–æ–±—ñ:–í–µ–ª–æ—Å–∏–ø–µ–¥–∏":[2000,60000],
    "–°–ø–æ—Ä—Ç/–•–æ–±—ñ:–¢—É—Ä–∏–∑–º":[300,20000],
    "–°–ø–æ—Ä—Ç/–•–æ–±—ñ:–ú—É–∑–∏—á–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏":[800,50000],

    "–¢–≤–∞—Ä–∏–Ω–∏:–ö–æ—Ç–∏":[0,3000],
    "–¢–≤–∞—Ä–∏–Ω–∏:–°–æ–±–∞–∫–∏":[0,8000],
    "–¢–≤–∞—Ä–∏–Ω–∏:–ó–æ–æ—Ç–æ–≤–∞—Ä–∏":[50,10000]
  };

  function genPhone(){ const op=pick(OPERATORS); return `+380 (${op}) ${rand(100,999)}-${rand(10,99)}-${rand(10,99)}`; }

  function seedDB(){
    const out=[]; const now=Date.now();
    // —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö –ø–∞—Ä cat-sub –¥–ª—è —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ–≥–æ –ø–æ–∫—Ä–∏—Ç—Ç—è
    const pairs=[];
    Object.keys(CATS).forEach(cat=> CATS[cat].forEach(sub=> pairs.push([cat,sub])));

    // 1) —Å–ø–æ—á–∞—Ç–∫—É –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –º—ñ–Ω—ñ–º—É–º –ø–æ 4 –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –Ω–∞ –∫–æ–∂–Ω—É –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é
    const MIN_PER_SUB = 4;
    pairs.forEach(([cat,sub])=>{
      for(let k=0;k<MIN_PER_SUB;k++){ out.push(makeItem(cat,sub, now)); }
    });
    // 2) –¥–æ–±–∏—Ä–∞—î–º–æ —Ä–µ—à—Ç—É –¥–æ 500 –¥–æ–≤—ñ–ª—å–Ω–æ –ø–æ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö
    while(out.length<500){
      const [cat,sub]=pick(pairs);
      out.push(makeItem(cat,sub, now));
    }
    localStorage.setItem(DB_KEY, JSON.stringify(shuffle(out)));
  }

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

  function makeItem(cat,sub, now){
    const rc = pick(CITIES);
    const range = PRICE[`${cat}:${sub}`] || [300,40000];
    const price = Math.max( (cat==="–¢–≤–∞—Ä–∏–Ω–∏" && (sub==="–ö–æ—Ç–∏"||sub==="–°–æ–±–∞–∫–∏")) ? 0 : 50,
                            Math.round(rand(range[0], range[1])/10)*10 );
    const year = rand(2005, 2025);
    const title = genTitle(cat,sub,year);
    const created = now - rand(0, 45*86400*1000); // –¥–æ 45 –¥–Ω—ñ–≤, —â–æ–± —Ñ—ñ–ª—å—Ç—Ä ¬´–∑–∞ 30¬ª –ø—Ä–∞—Ü—é–≤–∞–≤
    const views = rand(50, 5000);
    const likes = rand(0, Math.max(10, Math.round(views/20)));
    const img = imgBy(cat, sub);
    const name = `${pick(FIRSTNAMES)} ${pick(LASTNAMES)}`;
    const desc = pick([
      "–°—Ç–∞–Ω –≤—ñ–¥–º—ñ–Ω–Ω–∏–π, –¥–µ—Ç–∞–ª—å–Ω—ñ —Ñ–æ—Ç–æ –¥–æ–¥–∞—é. –¢–µ–ª–µ—Ñ–æ–Ω—É–π—Ç–µ/–ø–∏—à—ñ—Ç—å —É –∑—Ä—É—á–Ω–∏–π —á–∞—Å.",
      "–ú–æ–∂–ª–∏–≤–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –ù–æ–≤–æ—é –ø–æ—à—Ç–æ—é –∞–±–æ —Å–∞–º–æ–≤–∏–≤—ñ–∑. –¢–æ—Ä–≥ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π.",
      "–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–¥–∞–∂—É ‚Äî –æ–Ω–æ–≤–ª–µ–Ω–Ω—è/–ø–µ—Ä–µ—ó–∑–¥. –ì–æ—Ç–æ–≤–∏–π –¥–æ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫.",
      "–†–µ–∞–ª—å–Ω–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –¥–ª—è –¥–µ–º–æ, —É—Å–µ –ø—Ä–∞—Ü—é—î —è–∫ —Å–ª—ñ–¥."
    ]);
    return {
      id: uid(),
      region: rc.region,
      city: rc.city,
      cat, sub,
      title,
      price, currency:"‚Ç¥",
      cond: pick(CONDS), seller: pick(SELLERS),
      created, views, likes,
      desc,
      images: [img], // –∑–∞–≤–∂–¥–∏ —î —Ñ–æ—Ç–æ
      contact: {name, phone: genPhone()}
    };
  }

  function genTitle(cat, sub, year){
    const by = (b)=>b[Math.floor(Math.random()*b.length)];
    if(cat==="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" && sub==="–õ–µ–≥–∫–æ–≤—ñ –∞–≤—Ç–æ"){
      const brands=["Skoda Octavia","Toyota Camry","BMW 320d","Audi A4","VW Golf","Kia Sportage","Hyundai Tucson","Mazda 6","Mercedes C200","Volvo XC60"];
      return `${by(brands)} ${year}, —Å–µ—Ä–≤—ñ—Å–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è`;
    }
    if(cat==="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" && sub==="–ú–æ—Ç–æ"){
      const m=["Honda CB500F","Yamaha R6","Kawasaki Z650","Suzuki SV650"];
      return `${by(m)} ${year}, –ø—ñ—Å–ª—è –¢–û`;
    }
    if(cat==="–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞" && sub==="–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏") return by(["iPhone 13 128GB, —Å—Ç–∞–Ω 9/10","Samsung S21 256GB, –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π","Pixel 6 128GB, –∑ —á–µ–∫–æ–º"]);
    if(cat==="–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞" && sub==="–ù–æ—É—Ç–±—É–∫–∏/–ü–ö") return by(["MacBook Pro 16, i9/16/512","Lenovo ThinkPad T14, i5/16/512","Asus ROG, RTX –¥–ª—è —ñ–≥–æ—Ä"]);
    if(cat==="–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å" && sub==="–ö–≤–∞—Ä—Ç–∏—Ä–∏") return `${rand(1,3)}–∫, —Ü–µ–Ω—Ç—Ä, ${rand(28,85)} –º¬≤, –Ω–æ–≤–æ–±—É–¥–æ–≤–∞`;
    if(cat==="–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å" && sub==="–ë—É–¥–∏–Ω–∫–∏") return `–ë—É–¥–∏–Ω–æ–∫ ${rand(70,250)} –º¬≤, –¥—ñ–ª—è–Ω–∫–∞ ${rand(4,20)} —Å–æ—Ç–æ–∫`;
    if(cat==="–ü–æ—Å–ª—É–≥–∏" && sub==="–†–µ–º–æ–Ω—Ç") return by(["–†–µ–º–æ–Ω—Ç —Ç–µ—Ö–Ω—ñ–∫–∏ ‚Äî –≤–∏—ó–∑–¥","–ú–∞–π—Å—Ç–µ—Ä –Ω–∞ –≥–æ–¥–∏–Ω—É"]);
    if(cat==="–†–æ–±–æ—Ç–∞" && sub==="–í–∞–∫–∞–Ω—Å—ñ—ó") return by(["–ö—É—Ä'—î—Ä ‚Äî —â–æ–¥–µ–Ω–Ω—ñ –≤–∏–ø–ª–∞—Ç–∏","–ú–µ–Ω–µ–¥–∂–µ—Ä –∑ –ø—Ä–æ–¥–∞–∂—ñ–≤ ‚Äî —Å—Ç–∞–≤–∫–∞+%","–ë–∞—Ä–∏—Å—Ç–∞ ‚Äî –∑–º—ñ–Ω–∏ 2/2"]);
    return `${sub} ‚Äî –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è`;
  }

  /* ===== HOT (–¢–û–ü-10 –Ω–∞ 7 –¥–Ω—ñ–≤) ===== */
  function ensureHot(){
    const ctrl = getCtrl();
    const db = getDB();
    const now = Date.now();
    if(!ctrl.hotUntil || !ctrl.hotIds || now > ctrl.hotUntil || !Array.isArray(ctrl.hotIds)){
      const scored = db.map(x => ({
        id: x.id,
        score: (x.likes||0)*6 + (x.views||0) + Math.max(0, 5000 - (now - x.created)/1000)
      })).sort((a,b)=>b.score-a.score);
      ctrl.hotIds = scored.slice(0,10).map(s=>s.id);
      ctrl.hotUntil = now + 7*24*3600*1000;
      setCtrl(ctrl);
    }
    renderHot(ctrl.hotIds, ctrl.hotUntil);
  }
  function renderHot(ids, untilTs){
    const grid=$("#hotGrid"); grid.innerHTML="";
    const db = getDB();
    const until = new Date(untilTs);
    $("#hotUntil").textContent = until.toLocaleDateString('uk-UA');
    const items = ids.map(id => db.find(x=>x.id===id)).filter(Boolean);
    if(items.length){
      $("#hotPanel").style.display="block";
      items.forEach(it=>{
        const card=document.createElement('div'); card.className='hotCard'; card.onclick=()=>openDetail(it.id);
        const fallback=itemPNG(it.title,(it.price+it.created)%7);
        card.innerHTML=`
          <div class="thumb"></div>
          <div class="hotBadge">HOT</div>
          <div class="hotPrice">${it.price.toLocaleString('uk-UA')} ${it.currency}</div>
          <div class="hotBody">
            <div class="hotTTL">${it.title}</div>
            <div style="opacity:.85">${it.city} ‚Ä¢ ${it.cat}</div>
            <div style="opacity:.85">‚ô• ${it.likes||0} ‚Ä¢ üëÅ ${it.views||0}</div>
          </div>`;
        card.querySelector('.thumb').appendChild(createImg((it.images&&it.images[0])||"", it.title, fallback));
        grid.appendChild(card);
      });
    } else {
      $("#hotPanel").style.display="none";
    }
  }

  /* ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è ===== */
  const sRegion=$("#sRegion"), sCity=$("#sCity");
  fillSelect(sRegion, REGIONS, false);
  refreshCities(sCity, REGIONS[0], false);
  const mapSelectData={ sCat:Object.keys(CATS), sCond:CONDS, sSeller:SELLERS };
  Object.keys(mapSelectData).forEach(id=>{
    const el=$("#"+id); el.innerHTML=mapSelectData[id].map(x=>`<option value="${x}">${x}</option>`).join('');
  });
  const sSub=$("#sSubcat"); function updateSSub(){ sSub.innerHTML=(CATS[$("#sCat").value]||[]).map(x=>`<option value="${x}">${x}</option>`).join(''); }
  $("#sCat").addEventListener("change", updateSSub); updateSSub();
  sRegion.addEventListener('change', ()=> refreshCities(sCity, sRegion.value, false));

  $("#sSave").onclick=()=>{
    const ctrl=getCtrl(); const now=Date.now();
    if(ctrl.lastPost && now-ctrl.lastPost<60000){ alert("–ü—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –º–æ–∂–Ω–∞ –Ω–µ —á–∞—Å—Ç—ñ—à–µ 1 —Ä–∞–∑—É –Ω–∞ 60 —Å–µ–∫."); return; }
    const region=$("#sRegion").value, city=$("#sCity").value, cat=$("#sCat").value, sub=$("#sSubcat").value, title=$("#sTitle").value.trim();
    if(!region||!city||!cat||!sub||!title) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å/–º—ñ—Å—Ç–æ/–∫–∞—Ç–µ–≥–æ—Ä—ñ—é/–ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é/–∑–∞–≥–æ–ª–æ–≤–æ–∫.");
    const price=+(($("#sPrice").value||0)); if(!(price>=0 && price<=100000000)) return alert("–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü—ñ–Ω—É.");
    const phone=$("#sPhone").value.trim(); if(phone && !/^\+?\d[\d\s\-\(\)]{8,}$/.test(phone)) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π.");
    const desc=$("#sDesc").value.trim(); if(desc.length<20) return alert("–û–ø–∏—Å ‚â• 20 —Å–∏–º–≤–æ–ª—ñ–≤.");
    const cond=$("#sCond").value, seller=$("#sSeller").value;
    let imgs=($("#sImages").value||"").split("|").map(x=>x.trim()).filter(Boolean);
    if(!imgs.length){ imgs=[imgBy(cat, sub)]; } // –∑–∞–≤–∂–¥–∏ –¥–æ–¥–∞—î–º–æ —Ñ–æ—Ç–æ
    const db=getDB();
    db.unshift({
      id: uid(), region, city,
      cat, sub, title, price, currency:"‚Ç¥", cond, seller, created:now, views: rand(5,25), likes:0,
      desc, images: imgs, contact:{name:"–ü—Ä–æ–¥–∞–≤–µ—Ü—å", phone: phone||genPhone()}
    });
    setDB(db); ctrl.lastPost=now; setCtrl(ctrl); alert("–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ."); applyFilters(); ensureHot();
    $("#sTitle").value=""; $("#sPrice").value=""; $("#sPhone").value=""; $("#sDesc").value=""; $("#sImages").value="";
  };

  /* ===== –ü–æ—à—É–∫/—Ä–µ–Ω–¥–µ—Ä ===== */
  const grid=$("#grid"), resCount=$("#resCount"), btnMore=$("#btnMore"), sortBy=$("#sortBy");
  let page=0, pageSize=24, lastResults=[];

  function applyFilters(){
    const q=(fltQuery.value||"").trim().toLowerCase();
    const pmin= +(fltPriceMin.value||0);
    const pmax= +(fltPriceMax.value||0);
    const region=fltRegion.value||"";
    const city=fltCity.value||"";

    let arr=getDB().filter(it=>
      (!region || it.region===region) &&
      (!city || it.city===city) &&
      (!fltCat.value || it.cat===fltCat.value) &&
      (!fltSub.value || it.sub===fltSub.value) &&
      (!fltCond.value || it.cond===fltCond.value) &&
      (!fltSeller.value || it.seller===fltSeller.value) &&
      (!pmin || it.price>=pmin) &&
      (!pmax || it.price<=pmax) &&
      (!q || (it.title+' '+it.cat+' '+it.sub).toLowerCase().includes(q)) &&
      (!fltRecent.checked || (Date.now()-it.created)<=30*86400*1000)
    );

    arr.sort((a,b)=>{
      switch(sortBy.value){
        case "priceAsc": return a.price-b.price;
        case "priceDesc": return b.price-a.price;
        case "likesDesc": return (b.likes||0)-(a.likes||0);
        case "viewsDesc": return (b.views||0)-(a.views||0);
        default: return b.created-a.created;
      }
    });

    lastResults=arr; page=0; grid.innerHTML="";
    resCount.textContent=`${arr.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤`;
    renderMore();
  }
  function remainingCount(){ return Math.max(0, lastResults.length - page*pageSize); }
  function updateMoreUI(){ btnMore.style.display = remainingCount()>0 ? "inline-flex" : "none"; }
  function renderMore(){ const slice=lastResults.slice(page*pageSize,(page+1)*pageSize); slice.forEach(renderCard); page++; updateMoreUI(); }

  function like(id, silent=false){
    const db=getDB(); const idx=db.findIndex(x=>x.id===id); if(idx<0) return;
    const ctrl=getCtrl(); ctrl.liked = ctrl.liked||{};
    if(ctrl.liked[id]){ if(!silent) alert("–¢–∏ –≤–∂–µ –ª–∞–π–∫–Ω—É–≤ —Ü–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è üòâ"); return; }
    db[idx].likes = (db[idx].likes||0) + 1;
    setDB(db); ctrl.liked[id]=true; setCtrl(ctrl);
  }

  function renderCard(it){
    const el=document.createElement('article'); el.className="card"; el.setAttribute('role','button'); el.title="–î–∏–≤–∏—Ç–∏—Å—è";
    const fallback=itemPNG(it.title, (it.price+it.created)%7);
    const firstImg=(Array.isArray(it.images)&&it.images.length)?it.images[0]:null;
    el.innerHTML=`
      <div class="thumb">
        <button class="likeBtn" title="–õ–∞–π–∫">‚ô• <span>${it.likes||0}</span></button>
        <div class="badge">${it.price.toLocaleString('uk-UA')} ${it.currency||"‚Ç¥"}</div>
        <div class="views">üëÅ ${it.views||0}</div>
      </div>
      <div class="body">
        <div class="title">${it.title}</div>
        <div class="meta">${it.cat} ‚Ä¢ ${it.sub}</div>
        <div class="meta">${it.region} ‚Ä¢ ${it.city}</div>
      </div>`;
    const likeButton = el.querySelector(".likeBtn");
    likeButton.onclick=(e)=>{ e.stopPropagation(); like(it.id); likeButton.querySelector("span").textContent = ( (it.likes||0)+1 ); it.likes=(it.likes||0)+1; ensureHot(); };
    el.querySelector(".thumb").prepend(createImg(firstImg, it.title, fallback));
    el.onclick=()=>openDetail(it.id);
    grid.appendChild(el);
  }

  let applyLock=false;
  $("#btnApply").onclick=()=>{ if(applyLock) return; applyLock=true; applyFilters(); setTimeout(()=>applyLock=false, 400); };
  $("#btnReset").onclick=()=>{ $$("#searchPanel .select, #searchPanel .input").forEach(x=>{ if(x.tagName==='SELECT') x.selectedIndex=0; else x.value=""; }); fltRecent.checked=false; applyFilters(); };
  btnMore.onclick=renderMore; sortBy.onchange=applyFilters;

  /* ===== –î–µ—Ç–∞–ª—å–Ω–∞ + –≥–∞–ª–µ—Ä–µ—è ===== */
  let galIndex=0, galImgs=[], currentId=null;
  function spec(k,v){return `<div class="spec"><div class="h">${k}</div>${v}</div>`}

  function renderGallery(title){
    const gal=$("#dGal");
    gal.innerHTML=`<div class="big"><button class="navBtn navPrev" id="galPrev" aria-label="–ü–æ–ø–µ—Ä–µ–¥–Ω—î">‚Äπ</button><button class="navBtn navNext" id="galNext" aria-label="–ù–∞—Å—Ç—É–ø–Ω–µ">‚Ä∫</button></div>`;
    const big=gal.querySelector('.big'); const url=galImgs[galIndex];
    big.appendChild(createImg(url, 'photo', itemPNG(title,galIndex)));
    $("#galPrev").onclick=()=>{ galIndex=(galIndex-1+galImgs.length)%galImgs.length; renderGallery(title); };
    $("#galNext").onclick=()=>{ galIndex=(galIndex+1)%galImgs.length; renderGallery(title); };
  }
  document.addEventListener('keydown', (e)=>{
    if($("#detail").classList.contains('active')){
      if(e.key==='ArrowLeft') $("#galPrev")?.click();
      if(e.key==='ArrowRight') $("#galNext")?.click();
      if(e.key==='Escape') $("#dClose")?.click();
    }
  });

  function openDetail(id){
    const db=getDB(); const idx=db.findIndex(x=>x.id===id); if(idx<0) return; const it=db[idx];
    currentId=id;
    it.views=(it.views||0)+1; db[idx]=it; setDB(db);
    const d=$("#detail"); d.classList.add('active'); d.setAttribute('aria-hidden', 'false');
    $("#dClose").onclick=()=>{ d.classList.remove('active'); d.setAttribute('aria-hidden','true'); applyFilters(); ensureHot(); };
    $("#dLike").onclick=()=>{ like(id); $("#dLike").textContent="‚ô• –õ–∞–π–∫ +1"; };

    $("#dHeader").innerHTML=`
      <div class="title" style="font:700 20px/1.2 'Russo One'">${it.title}</div>
      <div class="pill yellow">${it.price.toLocaleString('uk-UA')} ${it.currency||"‚Ç¥"}</div>
      <div class="pill">‚ô• ${it.likes||0}</div>
      <div class="pill" style="margin-left:auto">üëÅ ${it.views}</div>`;
    const imgs=(Array.isArray(it.images)&&it.images.length)?it.images:[itemPNG(it.title,0),itemPNG(it.title,1),itemPNG(it.title,2)];
    galImgs = imgs; galIndex=0; renderGallery(it.title);

    $("#dSpecs").innerHTML=
      spec("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è", it.cat)+
      spec("–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è", it.sub)+
      spec("–û–±–ª–∞—Å—Ç—å", it.region)+
      spec("–ú—ñ—Å—Ç–æ", it.city)+
      spec("–°—Ç–∞–Ω", it.cond)+
      spec("–¢–∏–ø –ø—Ä–æ–¥–∞–≤—Ü—è", it.seller)+
      spec("–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ", fmtUA(it.created));

    $("#dDesc").textContent = it.desc||"";
    const initials=(it.contact?.name||"–ü")[0];
    $("#dSeller").innerHTML=`<div class="avatar">${initials}</div><div><div class="h">–ü—Ä–æ–¥–∞–≤–µ—Ü—å</div><div>${it.contact?.name||"–ü—Ä–æ–¥–∞–≤–µ—Ü—å"}</div><div style="opacity:.85">${it.contact?.phone||"‚Äî"}</div></div>`;
  }

  /* ===== –ü–µ—Ä—à–∏–π —Å—Ç–∞—Ä—Ç ===== */
  (function init(){
    if(getDB().length===0){ seedDB(); }
    applyFilters();
    ensureHot();
  })();

  /* –í–∫–ª–∞–¥–∫–∏ */
  $("#tabSearch").onclick=()=>{ $("#sellPanel").style.display="none"; window.scrollTo({top:0, behavior:"smooth"}); };
  $("#tabSell").onclick=()=>{ $("#sellPanel").style.display="block"; $("#sellPanel").scrollIntoView({behavior:'smooth', block:'start'}); };

  </script>
</body>
</html>
